{{define "player-search"}}
<script defer src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
</script>
<script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
</script>
<div class="modal fade" id="addPlayerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-md modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPlayerModalTitle">Player Search</h5>
                <button type="button" class="close" data-dismiss="modal">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="player-search-form">
                    <div class="form-inline">
                        <input class="form-control mr-2" type="search" name="q" id="player-search" placeholder="Search">
                        <button class="btn btn-outline-success" type="submit" form="player-search-form">Search</button>
                    </div>
                    <div class="form-check my-1">
                        <input class="form-check-input" type="checkbox" name="apo" id="active-players-only" checked>
                        <label class="form-check-label" for="active-players-only">Active Players Only</label>
                    </div>
                    <template id="player-search-results-template">
                        <fieldset id="player-search-results">
                            <legend>PlayerSearchResults</legend>
                        </fieldset>
                    </template>
                    <template id="player-search-result-template">
                        <div class="form-check my-1">
                            <input class="psr-radio form-check-input" type="radio" name="psr-selected" id="psr-0"
                                onchange="setNewPlayerSelected(true)">
                            <label class="psr-label form-check-label" for="psr-0">
                                <strong class="psr-label-name">?</strong>
                                <span class="psr-label-details">?</span>
                            </label>
                            <input class="psr-player-id" value="?" type="hidden">
                            <input class="psr-player-name" value="?" type="hidden">
                        </div>
                    </template>
                    <div id="results"></div>
                </form>
                <div class="modal-footer form-group">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="modal-add-player-button" type="button" class="btn btn-outline-primary"
                        data-dismiss="modal" disabled>Add Player</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function addPlayerFromSearch() {
        var playerSearchResults = document.getElementById('player-search-results');
        playerSearchResults = playerSearchResults.getElementsByClassName('form-check');
        for (var i = 0; i < playerSearchResults.length; i++) {
            var psr = playerSearchResults[i];
            if (psr.querySelector('.psr-radio').checked) {
                var playerID = psr.querySelector('.psr-player-id').value;
                var playerName = psr.querySelector('.psr-player-name').value;
                var newPlayer = addPlayer(playerName, playerID);
                newPlayer.focus();
                return;
            }
        }
    }

    function clearPlayerSearch() {
        var resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
    }

    document.getElementById("player-search-form")
        .addEventListener('submit', e => {
            e.preventDefault();
            setNewPlayerSelected(false);
            var playerTypeID = document.getElementById('select-player-type').value;
            var formData = new FormData(e.target);
            formData.append('pt', playerTypeID);
            var url = window.location.pathname + "/search?" + new URLSearchParams(formData);
            fetch(url, {
                method: 'GET',
            }).then(res => {
                if (res.status == 200) {
                    return res.json();
                } else {
                    return res.text()
                        .then(message => {
                            return Promise.reject(message);
                        });
                }
            }).then(playerSearchResults => {
                if (playerSearchResults != null && playerSearchResults.length > 0) {
                    searchSuccess(playerSearchResults);
                    return Promise.resolve();
                } else {
                    return Promise.reject('No results');
                }
            }).catch(err => {
                var resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = err;
            });
        });

    function searchSuccess(playerSearchResults) {
        var template = document.getElementById("player-search-results-template");
        var playerSearchResultsDiv = document.importNode(template.content, true);
        var playerSearchResultsFieldSet = playerSearchResultsDiv.getElementById('player-search-results');
        for (var i = 0; i < playerSearchResults.length; i++) {
            var playerSearchResult = playerSearchResults[i];
            var template2 = document.getElementById("player-search-result-template");
            var playerSerchResultDiv = document.importNode(template2.content, true);
            var psr = playerSerchResultDiv.querySelector('.form-check');
            psr.querySelector('.psr-radio').id = 'psr-' + playerSearchResult.PlayerID;
            psr.querySelector('.psr-label').htmlFor = 'psr-' + playerSearchResult.PlayerID;
            psr.querySelector('.psr-label-name').innerText = playerSearchResult.Name;
            psr.querySelector('.psr-label-details').innerText = playerSearchResult.Details;
            psr.querySelector('.psr-player-id').value = playerSearchResult.PlayerID;
            psr.querySelector('.psr-player-name').value = playerSearchResult.Name;
            playerSearchResultsFieldSet.appendChild(psr);
        }
        if (playerSearchResults.length == 1) {
            var psr = playerSearchResultsFieldSet.querySelector('.form-check');
            psr.querySelector('.psr-radio').checked = true;
            setNewPlayerSelected(true);
        }
        var resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(playerSearchResultsFieldSet);
    }

    function setNewPlayerSelected(isSelected) {
        var addPlayerButton = document.getElementById('modal-add-player-button');
        addPlayerButton.disabled = !isSelected;
    }
</script>
{{end}}