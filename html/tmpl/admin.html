{{define "content"}}
{{- if (eq .Action "players") -}}
{{- template "player-search" . -}}
{{end}}
<form id="{{.Action}}-form">

    {{- if (eq .Action "players") -}}
    {{- template "players" . -}}
    {{- else if (eq .Action "friends") -}}
    {{- template "friends" . -}}
    {{- else if (eq .Action "years") -}}
    {{- template "years" . -}}
    {{- else if (eq .Action "cache") -}}
    {{- template "cache" . -}}
    {{- else if (ne .Action "password") -}}
    <p class="bg-danger d-inline">Unknown Action: {{.Action}}</p>
    {{- end -}}
    {{- if .Data -}}
    <div class="form-group">
        <p class="bg-warning d-inline my-3">Removing {{.Action}} will delete them permanently on submit.</p>
    </div>
    {{- end -}}
    <div class="form-group">
        <label class="form-label" for="{{.Action}}-username">Username</label>
        <input class="form-control" id="{{.Action}}-username" name="username" type="text" autocomplete="username"
            required>
    </div>
    <div class="form-group">
        <label class="form-label" for="{{.Action}}-password">Password</label>
        <input class="form-control" id="{{.Action}}-password" name="password" type="password"
            autocomplete="current-password" required>
    </div>
    {{- if (eq .Action "password") -}}
    {{- template "password" . -}}
    {{end}}
    <div class="form-group">
        {{if .Data -}}
        <p id="template-support-check-{{.Action}}" class="bg-danger"></p>
        {{end -}}
        <p id="{{.Action}}-info"></p>
        <input name="action" type="hidden" value="{{.Action}}">
        <button class="btn btn-primary" form="{{.Action}}-form" id="{{.Action}}-form-submit-button"
            value="submit">Submit</button>
    </div>
</form>
<script>
    document.getElementById("{{.Action}}-form")
        .addEventListener('submit', e => {
            e.preventDefault();
            var pathname = window.location.pathname;
            const data = new URLSearchParams(new FormData(e.target));
            fetch(pathname, {
                    method: 'POST',
                    body: data,
                    credentials: 'include'
                }).then(res => {
                    if (res.status == 200) {
                        return res.text()
                    } else {
                        return res.text()
                            .then(message => {
                                return Promise.reject(message);
                            });
                    }
                })
                .then(message => {
                    if (window.PasswordCredential) {
                        var c = new PasswordCredential(e.target);
                        return navigator.credentials.store(c)
                            .then(() => {
                                return Promise.resolve(message);
                            });
                    } else {
                        return Promise.resolve(message);
                    }
                })
                .then(message => {
                    window.location = pathname + '?message=' + message + window.location.hash;
                }).catch(message => {
                    var actionInfo = document.getElementById("{{.Action}}-info");
                    actionInfo.classList.add('bg-danger');
                    actionInfo.innerText = message;
                });
        });
    var queryParams = new URLSearchParams(window.location.search);
    var message = queryParams.get('message');
    if (message === null) {
        message = "Enter password before submitting.";
    }
    document.getElementById("{{.Action}}-info").innerText = message;

    if (!('content' in document.createElement('template'))) {
        var templateSupportCheckDiv = document.getElementById('template-support-check-{{.Action}}');
        templateSupportCheckDiv.innerText =
            'HTML <template> tag not supported in browser, so {{.Action}} editor cannot be shown.';
    }
</script>
{{end}}