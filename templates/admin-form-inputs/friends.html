{{define "friends"}}
<fieldset>
    <legend>Friends</legend>
    <div id="friends">
        <template id="friend-template">
            <div class="form-group">
                <!-- TODO: do this for years -->
                <label class="friend-name-label form-label"></label>
                <input class="friend-name-input form-control" class="form-control" required>
                <input class="friend-display-order" type="hidden">
                <button class="btn btn-light" type="button" title="Move Up" onclick="moveFriendUp()">▲</button>
                <button class="btn btn-light" type="button" title="Move Down" onclick="moveFriendDown()">▼</button>
                <button class="btn btn-danger" type="button" title="Remove" onclick="removeFriend()">×</button>
            </div>
        </template>
    </div>
</fieldset>
<button class="btn btn-secondary" type="button" title="Add Friend" onclick="addFriend()">Add Friend</button>
<script>
    function moveFriendUp() {
        var friend1 = event.target.parentNode;
        var friend2 = event.target.parentNode.previousElementSibling;
        if (friend2 != null) {
            var friends = friend1.parentNode;
            friends.insertBefore(friend1, friend2);
            changeFriendDisplayOrder(friend1.id, -1);
            changeFriendDisplayOrder(friend2.id, +1);
        }
    }

    function moveFriendDown() {
        var friend1 = event.target.parentNode;
        var friend2 = event.target.parentNode.nextElementSibling;
        if (friend2 != null) {
            var friends = friend1.parentNode;
            friends.insertBefore(friend2, friend1);
            changeFriendDisplayOrder(friend2.id, -1);
            changeFriendDisplayOrder(friend1.id, +1);
        }
    }

    function removeFriend() {
        var removeFriend = event.target.parentNode;
        for (var friend = document.getElementById(removeFriend.id).nextElementSibling; friend != null; friend = document
            .getElementById(friend.id).nextElementSibling) {
            changeFriendDisplayOrder(friend.id, -1);
        }
        removeFriend.remove();
    }

    function addFriend() {
        var friendsParent = event.target.previousElementSibling.lastElementChild;
        var maxFriendId = 0
        // get max friend ID from friends
        var friendElements = friendsParent.children;
        for (var i = 0; i < friendElements.length; i++) {
            var friendElement = friendElements[i]
            var friendElementId = friendElement.id.substring('friend-'.length);
            if (friendElementId > maxFriendId) {
                maxFriendId = friendElementId;
            }
        }
        createFriend(maxFriendId + 1, '', friendElements.length, '[NEW]');
    }

    function createFriend(id, name, displayOrder, nameLabel) {
        var template = document.querySelector("#friend-template");
        var clone = document.importNode(template.content, true);
        var friend = clone.querySelector('.form-group');
        friend.id = 'friend-' + id;
        friend.querySelector('.friend-name-label').for = 'friend-' + id + '-name';
        friend.querySelector('.friend-name-label').innerText = nameLabel
        friend.querySelector('.friend-name-input').id = 'friend-' + id + '-name';
        friend.querySelector('.friend-name-input').name = 'friend-' + id + '-name';
        friend.querySelector('.friend-name-input').value = name;
        friend.querySelector('.friend-display-order').id = 'friend-' + id + '-display-order';
        friend.querySelector('.friend-display-order').name = 'friend-' + id + '-display-order';
        friend.querySelector('.friend-display-order').value = displayOrder;
        var friends = document.querySelector("#friends");
        friends.appendChild(clone);
    }

    function changeFriendDisplayOrder(friendID, delta) {
        var friend = document.getElementById(friendID);
        var friendDisplayOrderElement = friend.querySelector('.friend-display-order')
        var friendDisplayOrder = friendDisplayOrderElement.value;
        friendDisplayOrderElement.setAttribute('value', parseInt(friendDisplayOrder) + delta);
    }
</script>
{{range $index, $friendScore := .Data}}
<script>
    createFriend("{{$friendScore.FriendID}}", "{{$friendScore.FriendName}}", "{{$index}}",
        "{{$friendScore.FriendName}}");
</script>
{{end}}
{{end}}